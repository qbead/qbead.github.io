<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:og="http://ogp.me/ns#" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <link rel="apple-touch-icon-precomposed" href="/colorwheel180.png">
  <link rel="icon" href="/colorwheel196.png">
  <meta property="og:title" content="The SpinWheel" />
  <meta property="og:type" content="website" />
  <meta property="og:description" content="Children have the natural curiosity and capacity to engineer a better world. Our kits just remind them." />
  <meta property="og:image" content="https://spinwearables.com/hanging.jpg" />
  <link rel="image_src" href="https://spinwearables.com/hanging.jpg" />
  <meta name="keywords" content="stepcounter, motion, acceleration" />
  <title>Make a Step Counter</title>
  <style>
  </style>
  <style>
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="/custom.css" />
  <link rel="stylesheet" href="/custom_book.css" />
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" type="text/javascript"></script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
<!-- Matomo -->
<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//matomo.spinwearables.com/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->
</head>
<body>
<!-- Matomo Image Tracker-->
<noscript><img src="https://matomo.spinwearables.com/matomo.php?idsite=1&amp;rec=1" style="border:0" alt="" /></noscript>
<!-- End Matomo -->
<header>
<div class="nav">
<a href="/">The SpinWheel</a>
 | 
<a href="/book">The Field Guide</a>
</div>
<img src="/images/banners/stepcounter.png">
<h1 class="title">Make a Step Counter</h1>
</header>
<main>
<div class="intro-box">
<p>A step counter needs to detect motion, record the movement, and display the total number of steps taken. The SpinWheel has a motion sensor that can deal with the first task, a small controller (computer) that can record this data, and a number of LEDs that can be used as a display. Here we will see how to put these features together to make our own custom step counter.</p>
</div>
<p>To start, plug the SpinWheel into your computer and open up an “empty” sketch in the Arduino software. If you need help remembering how to do this, you can get a recap of how to connect your SpinWheel to your computer in our <a href="/quickstart">Initial Setup Guide</a>.</p>
<h2 id="from-an-empty-sketch">From an Empty Sketch</h2>
<p>We will build our Step Counter program step by step, starting with this empty sketch. A good first step is to write some simple test code that just prints a few messages, confirming that your device is still functioning. For instance, copy the following code into your file. This code, once running on the SpinWheel, will repeatedly send the message “I am working!” to the computer that your SpinWheel is attached to. As always, we will add comments to the code, so that the purpose of each line is explained. (A comment is a line of code that is not run by the computer, but meant to be interpreted by humans. In this code, comment lines start with <code>//</code>).</p>
<div class="further-reading">
<p>You can consult our <a href="/basics">SpinWheel basic commands page</a> to remind yourself how to read the computer code shown below. For more details about coding itself, check out the <a href="/progpatterns">Coding Building Blocks page</a>.</p>
</div>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&quot;SpinWearables.h&quot;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="kw">using</span> <span class="kw">namespace</span> SpinWearables;</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a><span class="dt">void</span> setup() {</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a>  <span class="co">// Connect to the computer, so we can read status messages.</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a>  Serial.begin(<span class="dv">115200</span>);</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a>  <span class="co">// Ensure the special SpinWheel hardware is working.</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a>  SpinWheel.begin();  </span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a>}</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a><span class="dt">void</span> loop() {</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true"></a>  <span class="co">// Send a confirmation message over and over.</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true"></a>  Serial.println(<span class="st">&quot;I am working!&quot;</span>); </span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true"></a>}</span></code></pre></div>
<p>If you upload this sketch to the SpinWheel, you won’t be able to see anything happen. It doesn’t turn on the LEDs, instead the sketch simply set ups the SpinWheel and sends a confirmation message (“I am working!”) repeatedly using <code>Serial.println()</code>. If you want to see this message, navigate to <code>Tools -&gt; Serial Monitor</code> in the Arduino software.</p>
<h2 id="measuring-motion">Measuring Motion</h2>
<p>Now we can begin to add useful functionality to our sketch. The first step is to ensure that the SpinWheel can measure something related to its motion. The function <code>loop</code> is repeatedly being called by our SpinWheel. Each time this happens, we want to instruct the motion sensor to report the new values it has measured. We do this by calling <code>SpinWheel.readIMU()</code> where IMU stands for Inertial Measurement Unit: a fancy name for something that senses motion. This function will return 3 acceleration values, one for each direction of motion.</p>
<!--TODO: Explain the directions of motion a little more here or link to vectors here instead of below? -->
<p>We want to measure a single number related to the overall motion of the SpinWheel, i.e. we do not care which of the 3 directions in space has the strongest motion. One way to do this is to combine the 3 values describing the motion along each direction into one single number. Mathematicians call this “calculating the magnitude” or “calculating the norm” of a “vector”.</p>
<div class="further-reading">
<p>If you want to learn more about what vectors are and how they are used by mathematicians and engineers, check out our lesson on <a href="/vectors">“Vectors”</a>.</p>
</div>
<p>A convenient way to get this “magnitude” is to calculate <span class="math inline">\(\sqrt{a_x^2+a_y^2+a_z^2}\)</span>, where <span class="math inline">\(a_x\)</span> is the acceleration in the x direction that was read by the <code>SpinWheel.readIMU()</code> function, <span class="math inline">\(a_y\)</span> corresponds to the y direction, and <span class="math inline">\(a_z\)</span> corresponds to the z direction. The code to do this operation looks like <code>sqrt(pow(SpinWheel.ax,2) + pow(SpinWheel.ay,2) + pow(SpinWheel.az,2))</code>. We will save this value in the variable <code>total_acceleration</code>.</p>
<p>We will also send this value to the computer connected to the SpinWheel to confirm that everything is working. The command <code>Serial.print(total_acceleration)</code> does just this. Once the code is running on the SpinWheel, we can use <code>Tools -&gt; Serial Plotter</code> in the Arduino software to visualize the results.</p>
<video src="/images/bookpics/stepcounter_nolights.mp4" muted autoplay playsinline loop>
</video>
<p>Here is all the code put together (if you want to open this sketch in the Arduino software to add it to your SpinWheel, navigate to <code>Examples → SpinWearables → Step_Counter →  Detect_Total_Acceleration</code>):</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&quot;SpinWearables.h&quot;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="kw">using</span> <span class="kw">namespace</span> SpinWearables;</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a><span class="dt">void</span> setup() {</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>  Serial.begin(<span class="dv">115200</span>);</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>  SpinWheel.begin();</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a>}</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a><span class="dt">void</span> loop() {</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a>  SpinWheel.readIMU();</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a>  <span class="co">// The &quot;sum of the squares&quot; is a common way to measure total ammount of</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a>  <span class="co">// motion independent of direction. Mathematicians call it &quot;the norm of</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a>  <span class="co">// the vector describing the motion&quot;.</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>  <span class="dt">float</span> total_acceleration = sqrt(pow(SpinWheel.ax,<span class="dv">2</span>) + pow(SpinWheel.ay,<span class="dv">2</span>) + pow(SpinWheel.az,<span class="dv">2</span>));</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true"></a>  Serial.print(total_acceleration);</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true"></a>  Serial.println();</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true"></a>}</span></code></pre></div>
<p>You might have noticed that we are currently only detecting motion; we are not actually counting steps yet. Since writing the code to make the SpinWheel into a step counter is complicated, it is helpful to break it up into less complicated steps. Through programming the SpinWheel, we will help you learn how to split big problems into small pieces for yourself. We hope you will find this skill useful not only when programming!</p>
<h2 id="displaying-motion">Displaying Motion</h2>
<p>Our next task is to change the SpinWheel’s LEDs based on the motion data we have collected. Having visual feedback at each stage of our work makes it easier to detect errors in our code. We will use the <code>setLargeLEDsUniform</code> function to turn all 8 of the large LEDs on at the same time. We will use an equal mixture of red, green, and blue, in order to make them light up in white.</p>
<div class="further-reading">
<p>To further explore why we can trick our brains to perceive a mixture of red, green, and blue colors as white, check out the <a href="/sight">Biology of Sight adventure</a>.</p>
</div>
<p>The intensity of each color will be proportional to the detected acceleration. However, you might have noticed that the <code>total_acceleration</code> value is 1, not 0, at rest. This is because the motion sensor (called an accelerometer) cannot distinguish between the force of gravity acting on it at all times, and the forces of inertia acting on it when you shake it. To account for that, we subtract 1 (the magnitude of gravity) from <code>total_acceleration</code>. This is how we obtain <code>kinematic_acceleration = total_acceleration - 1</code>. “Kinematic” is a fancy word physicists use to refer to things related to motion. We calculate intensity based on that value with <code>intensity = 20*kinematic_acceleration</code> and use it in the <code>setLargeLEDsUniform</code> function. We chose a factor of 20 in order to make the LEDs brighter.</p>
<p>Here is all the code put together (you can find it in <code>Examples → SpinWearables → Step_Counter →  Detect_Kinematic_Acceleration</code>):</p>
<div class="further-reading">
<p>There are a lot of intricate facts about motion and gravity that relate to why our motion sensor can not distinguish between the two. You can read more about it in the section on <a href="/inertia">inertial reference frames and free fall</a>, which will also explain why <code>total_acceleration</code> at rest, as measured by our sensor, is 1 unit. Einstein himself was thinking about this everyday fact when he was developing the general theory of relativity.</p>
</div>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&quot;SpinWearables.h&quot;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a><span class="kw">using</span> <span class="kw">namespace</span> SpinWearables;</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a><span class="dt">void</span> setup() {</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a>  Serial.begin(<span class="dv">115200</span>);</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a>  SpinWheel.begin();</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a>}</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a><span class="dt">void</span> loop() {</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a>  SpinWheel.readIMU();</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true"></a>  <span class="co">// `total_acceleration` includes the effect of the </span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true"></a>  <span class="co">// gravitational field even at rest. </span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true"></a>  <span class="dt">float</span> total_acceleration = sqrt(pow(SpinWheel.ax,<span class="dv">2</span>) + pow(SpinWheel.ay,<span class="dv">2</span>) + pow(SpinWheel.az,<span class="dv">2</span>));</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true"></a>  <span class="co">// For sensing motion, we want only the component of that measurement</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true"></a>  <span class="co">// that is related to motion.</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true"></a>  <span class="co">// Kinematic is a fancy word for &quot;related to moving&quot;.</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true"></a>  <span class="dt">float</span> kinematic_acceleration = abs(total_acceleration - <span class="fl">1.0</span>); </span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true"></a>  <span class="co">// Turn on the large LEDs when noticing motion.</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true"></a>  <span class="co">// The intensity for each color goes from 0 to 255 on the SpinWheel,</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true"></a>  <span class="co">// so we multiply the value of the kinematic_acceleration by a largish</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true"></a>  <span class="co">// number, to make the light more noticeable.</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true"></a>  <span class="dt">int</span> intensity = <span class="dv">20</span>*kinematic_acceleration;</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true"></a>  <span class="co">// We mix equal red, green, and blue for white light.</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true"></a>  SpinWheel.setLargeLEDsUniform(intensity, intensity, intensity);</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true"></a>  <span class="co">// And we tell the SpinWheel to show the light pattern we registered on</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true"></a>  <span class="co">// the previous line.</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true"></a>  SpinWheel.drawFrame();</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true"></a>  Serial.print(intensity);</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true"></a>  Serial.println();</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true"></a>}</span></code></pre></div>
<h2 id="counting-steps">Counting Steps</h2>
<p>Finally, we can achieve our goal: using the SpinWheel to display all detected motion, showing how much we have moved over time. We will simply add up the values for “kinematic_acceleration”. For this, we don’t have to be particularly precise: we just want one number that contains some information about the total motion we have exerted. We can call that variable <code>total_motion</code> and each time we detect motion we update it with <code>total_motion = total_motion + conversion_factor * kinematic_acceleration</code>. We introduced the small number <code>conversion_factor</code> so that we keep the value of <code>total_motion</code> growing slowly.</p>
<p>We only want motions of a certain size to be counted as steps. For example, if you take a step, we want that to be counted, but we don’t want slight movements, such as the jitter of the hand holding your SpinWheel, to be counted.</p>
<p>We can do this by introducing a minimum <code>threshold</code> under which motion is not counted. We do this by using an <code>if</code> statement of the form <code>if (kinematic_acceleration&gt;threshold)</code>. Without this addition to our code, small vibrations would be falsely included in our count. You can observe this effect in the interactive chart below. In the chart, you can see the grey line depicting the values reported by the motion sensor. By manipulating the slider, you can change the threshold at which values are counted in the total. If the threshold is too low, all the small vibrations detected by the sensor are counted, falsely inflating the total sum. However, by setting the threshold higher, we are able to count only the three very noticeable strong motions (i.e. the peaks that approach a value of 1 on the y-axis): they actually correspond to real steps and need to be counted. But if we set the threshold too high, then none of the motions are counted, and once again, the stepcounter will not work properly.</p>
<!--TODO: Make the plot fit with the rest of the aesthetics. Maybe use rough.js -->
<script src='/chart/Chart.bundle.min.js'></script>
<div style="text-align:center">
<div>
<input style="width:30%;" type="range" min="0" max="100" value="20" id="thrSlider"> Use this slider to set the threshold.
</div>
<div>
The threshold is set at <code id="thrView"></code> which leads to a total sum of <code id="thrSum"></code>.
</div>
</div>
<div style="width:100%;height:200px;">
<canvas id="thresholdchart">
</canvas>
</div>
<script>
var thrSlider = document.getElementById('thrSlider');
var thrView = document.getElementById('thrView');
var thrSum = document.getElementById('thrSum');
function thrUpdate() {
  var t = thrSlider.value/100;
  thrChart.data.datasets[0].data.fill(t);
  thrChart.update()
  thrView.innerHTML = t;
  thrSum.innerHTML = samples.filter(x=>x>t).reduce((a,b)=>a+b,0).toFixed(1);
}
thrSlider.oninput = thrUpdate;
var samples = Array(40).fill(0).map((x,i)=>Math.random()*0.25);
samples[10] = 0.8;
samples[11] = 0.9;
samples[12] = 0.7;
samples[20] = 0.7;
samples[21] = 0.9;
samples[22] = 0.8;
samples[30] = 0.9;
samples[31] = 0.7;
samples[32] = 0.8;
var indices = Array(40).fill(0).map((x,i)=>'');
var threshold = Array(40).fill(0.2);
var ctx = document.getElementById('thresholdchart').getContext('2d');
var thrChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: indices,
        datasets: [{
            label: 'threshold',
            data: threshold,
            fill: false,
            pointRadius: 0,
            borderColor: 'red'
          },{
            label: 'motion measurements',
            data: samples,
            fill: false,
            pointRadius: 0,
            borderColor: '#ccc'
        }]
    },
    options: {
        maintainAspectRatio: false,
        tooltips: {enabled: false},
        scales: {
            xAxes: [{
                scaleLabel: {labelString: 'time', display: true},
                ticks: {
                    min:0,
                    max:40
                },
                gridLines: {display: false}
            }],
            yAxes: [{
                scaleLabel: {labelString: 'value', display: true},
                ticks: {
                    min:0,
                    max:1
                },
                gridLines: {display: false}
            }]
        }
    }
});
thrUpdate();
</script>
<p>Finally, we use the 12 smaller LEDs in order to show the value of <code>total_motion</code>. If <code>total_motion</code> is 1, we light up only the first LED. If it is 5, we light up the first five LEDs, and so on. We use the <code>SpinWheel.setSmallLEDs()</code> function to do this.</p>
<p>Below you can see the code in its entirety, and <a href="#stepcounter-sim1">at the bottom of the page</a> you can try running it on a virtual SpinWheel. To add this code to your SpinWheel, go to <code>Examples → SpinWearables → Step_Counter →  Fancy_Step_Counter</code>):</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&quot;SpinWearables.h&quot;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a><span class="kw">using</span> <span class="kw">namespace</span> SpinWearables;</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a><span class="dt">void</span> setup() {</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a>  Serial.begin(<span class="dv">115200</span>);</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a>  SpinWheel.begin();</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a>}</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a><span class="dt">float</span> total_motion = <span class="dv">0</span>;</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a><span class="dt">float</span> threshold = <span class="fl">0.1</span>;</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a><span class="dt">float</span> conversion_factor = <span class="fl">0.01</span>;</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true"></a><span class="dt">void</span> loop() {</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true"></a>  SpinWheel.readIMU();</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true"></a>  <span class="dt">float</span> total_acceleration = sqrt(pow(SpinWheel.ax,<span class="dv">2</span>) + pow(SpinWheel.ay,<span class="dv">2</span>) + pow(SpinWheel.az,<span class="dv">2</span>));</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true"></a>  <span class="dt">float</span> kinematic_acceleration = abs(total_acceleration - <span class="fl">1.0</span>); </span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true"></a>  <span class="dt">int</span> intensity = <span class="dv">20</span>*kinematic_acceleration;</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true"></a>  SpinWheel.setLargeLEDsUniform(intensity, intensity, intensity);</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true"></a>  <span class="co">// Accumulate all of the motion readings over time in a single number.</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true"></a>  <span class="co">// To avoid false readings, perform the accumulation only if the motion</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true"></a>  <span class="co">// was sufficiently strong.</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true"></a>  <span class="cf">if</span> (kinematic_acceleration&gt;threshold) {</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true"></a>    total_motion = total_motion+conversion_factor*kinematic_acceleration;</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true"></a>  }</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true"></a>  <span class="co">// Display how much you have moved, by turning on the corresponding</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true"></a>  <span class="co">// number of small LEDs.</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true"></a>  SpinWheel.setSmallLEDs(<span class="dv">0</span>,total_motion,<span class="dv">255</span>,<span class="dv">255</span>,<span class="dv">255</span>);</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true"></a>  SpinWheel.drawFrame();</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true"></a>  Serial.print(total_motion);</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true"></a>  Serial.println();</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true"></a>}</span></code></pre></div>
<p>You might need to experiment with the value of <code>conversion_factor</code> in order to make your device present the total number of steps in a way you like. In the video below, we have also changed some of the colors. Can you do something similar? Under the video, there is a widget which you can use to experiment with this code in your browser without needing a physical SpinWheel.</p>
<video src="/images/bookpics/stepcounter_final.mp4" muted autoplay playsinline loop>
</video>
<div class="further-reading">
<p>Other interesting features would be to show different colors when the detected acceleration is too small to be counted. Moreover, you can use the colors of the small LEDs to give more information. For instance, this is one way that you can modify the code that we presented to allow your step counter to display a count of your steps past 12. Another way you could do this is modify the device so the LEDs only light up every 10, or 100 steps.</p>
</div>
<h2 id="virtual-spinwheel">Virtual SpinWheel</h2>
<p>You can use this simulation of a SpinWheel to play with the code without uploading it to a physical device. After clicking “Run”, you can grab the image of the SpinWheel and shake it to have the virtual device respond to that motion. Try to play with the threshold value, change colors, and even change how quickly the small LEDs turn on.</p>
<link rel="stylesheet" href="/simspinwheel/simspinwheel.css">
<script src='/simspinwheel/simspinwheel.js'></script>
<div id="stepcounter-sim1" class="ssw-codecontent" data-markdown="0">
<textarea class="ssw-codeblock">
float total_motion = 0;
float threshold = 0.1;
float conversion_factor = 0.2;
</textarea>
<pre class="ssw-codeblock">

void loop() {
  SpinWheel.readIMU();
</pre>
<textarea class="ssw-codeblock">
  float total_acceleration = sqrt(pow(SpinWheel.ax,2)
                                 +pow(SpinWheel.ay,2)
                                 +pow(SpinWheel.az,2));
</textarea>
<pre class="ssw-codeblock">
  float kinematic_acceleration = abs(total_acceleration - 1.0); 
</pre>
<textarea class="ssw-codeblock">
  int intensity = 2000*kinematic_acceleration;
  SpinWheel.setLargeLEDsUniform(intensity, 0, intensity);
</textarea>
<pre class="ssw-codeblock">
  if (kinematic_acceleration>threshold) {
    total_motion = total_motion+conversion_factor*kinematic_acceleration;
  }
</pre>
<textarea class="ssw-codeblock">
  SpinWheel.setSmallLEDs(0,total_motion,255,0,0);
</textarea>
<pre class="ssw-codeblock">
  SpinWheel.drawFrame();
}
</pre>
</div>
<script data-isso="//comments.spinwearables.com/"
data-isso-reply-to-self="false"
data-isso-require-author="true"
data-isso-require-email="true"
data-isso-avatar="false"
data-isso-vote="false"
src="//comments.spinwearables.com/js/embed.min.js"></script>
<section id="isso-thread"></section>
<script>
document.querySelector("#isso-thread").addEventListener(
  "click",
  function () {
    document.querySelectorAll("#isso-thread > div").forEach(function (x) {x.style.display = "block";});
  });
</script>
</main>
<div id="license">
<!--<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="/cc-by-sa.png" /></a> This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.-->
<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="/cc-by-sa.png" /></a></a> This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>. © SpinWearables LLC (<a href="/license">license and trademark details</a>)
</div>
</body>
</html>
